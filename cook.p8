pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
  game = {}
  run_level()
end

function _update()
  game.update()
end

function _draw()
  game.draw() 
end

function run_level()
  instructions = {
    x = 81,
    y = 48,
    draw = function(self)
      local lx, ly = self.x, self.y
      rect(lx,ly,126,48 + 32 -1,7)
      lx += 2
      ly += 2
      print(order.instructions.up,lx,ly,7)
      ly += 6
      print(order.instructions.down,lx,ly,7)
      ly+=6
      print('❎ serve',lx,ly,7)
    end
  }

  score = 0

  order = make_donut()
  order:pick_version()
  order:assign_food()
  
  game.update = level_update
  game.draw = level_draw
end

function level_update()
  order:update()
  if btnp(5) then
    if order:is_correct() then score += 1 end
    order = make_donut()
    order:pick_version()
    order:assign_food()
  end
end

function level_draw()
  cls()
  rectfill(0,0,127,127,13) --backgorund
  print(score,0,0,7)
  rectfill(48,48,48 + 32 -1,48 + 32 -1,1) --stage
  -- line(0,63,63,63,0)
  -- line(63,63,63,127,0)
  rectfill(0,104,127,127,15) --order text
  print(order.order_text,1,105,0) --order text
  order:draw()
  instructions:draw()
  print(order.attrs.choc,10,10,7)
  print(order.food.attrs.choc,20,20,7)
end

function make_order(food)
  return food:pick_version()
end

function make_donut()
  local d = {
    attrs = {
     choc = false,
     sprinkles = false
    },
    food,
    assign_food = function(self)
     self.food = make_donut()
    end,
    pick_version = function(self)
      local num = flr(rnd(4))  
      if num == 0 then
        self.attrs.choc = true
        self.order_text = 'just chocolate please'
      elseif num == 1 then
        self.attrs.sprinkles = true
        self.order_text = 'i only want sprinkles'
      elseif num == 2 then
        self.attrs.choc = true
        self.attrs.sprinkles = true
        self.order_text = 'gimme everything!'
      else
        self.order_text = 'i like it plain'
      end
    end,
    order_text,
    update = function(self)
      if btnp(2) then self.food.attrs.choc = true end
      if btnp(3) then self.food.attrs.sprinkles = true end
    end,
    draw = function(self)
      if self.food.attrs.choc == true then pal(15,4) end
      spr(0,64 - 8,64 - 12,1,3)
      spr(0,64 - 8 + 8,64 - 12,1,3,true,false)
      if self.food.attrs.sprinkles then
        pset(59,59,11)
        pset(63,56,14)
        pset(70,64,11)
        pset(61,67,14)
        pset(69,67,14)
        pset(59,69,11)
        pset(69,58,11)
      end
      line(68,61,68,65,7) -- shine
      pset(67,66,7) -- shine
      pal()
    end,
    instructions = {
      up = '⬆️ choc',
      down = '⬇️ sprnkls'
    },
    is_correct = function(self)
      return self.attrs.choc == self.food.attrs.choc and self.attrs.sprinkles == self.food.attrs.sprinkles
    end
  }
  return d
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffff99000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
099fffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
